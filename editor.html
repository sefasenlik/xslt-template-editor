<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XSLT Editor with Live Preview</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.css">
  <style>
    :root {
      --1ci-blue: #0075c9;
      --1ci-dark-blue: #004b8d;
      --1ci-light-gray: #f1f4f7;
      --text-dark: #333;
      --text-light: #fff;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--1ci-light-gray);
      color: var(--text-dark);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      background: var(--1ci-blue);
      color: var(--text-light);
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    header img {
      height: 34px;
    }

    header span {
      font-size: 1.5rem;
      font-weight: bold;
    }

    main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    section {
      box-sizing: border-box;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    section:nth-child(1) {
      flex: 0.7;
      background-color: #ffffff;
      border-right: 1px solid #ccc;
    }

    section:nth-child(2) {
      flex: 1.3;
    }

    section:nth-child(3) {
      flex: 1;
      background-color: white;
      border-left: 1px solid #ccc;
    }

    .CodeMirror {
      height: 100%;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    input[type="file"], button {
      background: var(--1ci-blue);
      color: var(--text-light);
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    label {
      font-weight: bold;
    }

    .file-input-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    #downloadBtn {
      margin-top: 0.5rem;
      width: fit-content;
    }

    .thumbnail {
      display: grid;
      grid-template-columns: 60px 1fr;
      align-items: center;
      gap: 0.5rem;
      margin: 0.5rem 0;
    }

    .thumbnail img {
      max-height: 50px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #newImageOutput {
      background: #fafafa;
      padding: 0.5rem;
      color: #444;
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-all;
      border: 1px solid #ccc;
      border-radius: 4px;
      position: relative;
    }

    .output-controls {
      margin-top: 0.5rem;
      display: flex;
      gap: 0.5rem;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://www.1ci.com/local/templates/1ci/i/1Ci-Logo-Dark-40x34.svg" alt="1Ci logo">
    <span>XSLT Editor with Live Preview</span>
  </header>
  <main>
    <section>
      <div class="file-input-group">
        <label for="xmlFile">üìÑ XML File:</label>
        <input type="file" id="xmlFile" accept=".xml" />

        <label for="xsltFile">üìú XSLT File:</label>
        <input type="file" id="xsltFile" accept=".xslt,.xsl" />

        <button id="downloadBtn">‚¨áÔ∏è Download Modified XSLT</button>
      </div>

      <div>
        <label>üñºÔ∏è Detected Images:</label>
        <div id="imageList"></div>
      </div>

      <div>
        <label>‚ûï Add Signature or Image:</label>
        <input type="file" id="newImageUpload" accept="image/*" />
        <div id="newImageOutput"></div>
        <div class="output-controls">
          <button onclick="copyImageCode()">üìã Copy to Clipboard</button>
          <button onclick="clearImageOutput()">üßπ Clear</button>
        </div>
      </div>
    </section>
    <section>
      <label>‚úèÔ∏è Edit XSLT:</label>
      <textarea id="xsltEditor"></textarea>
    </section>
    <section>
      <label>üîç Live Preview:</label>
      <iframe id="preview"></iframe>
    </section>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/xml/xml.min.js"></script>
  <script>

     const xmlFileInput = document.getElementById('xmlFile');
    const xsltFileInput = document.getElementById('xsltFile');
    const downloadBtn = document.getElementById('downloadBtn');
    const previewFrame = document.getElementById('preview');
    const imageList = document.getElementById('imageList');
    const newImageUpload = document.getElementById('newImageUpload');
    const newImageOutput = document.getElementById('newImageOutput');

    let xmlDoc = null;

    const xsltEditor = CodeMirror.fromTextArea(document.getElementById("xsltEditor"), {
      mode: "application/xml",
      lineNumbers: true,
      indentUnit: 2,
      tabSize: 2,
      indentWithTabs: false,
      smartIndent: true,
      theme: "default"
    });

    function updatePreview() {
      if (!xmlDoc) return;

      const parser = new DOMParser();
      const xsltString = xsltEditor.getValue();
      const xsltDoc = parser.parseFromString(xsltString, 'text/xml');
      const xsltProcessor = new XSLTProcessor();

      try {
        xsltProcessor.importStylesheet(xsltDoc);
        const resultDocument = xsltProcessor.transformToDocument(xmlDoc);
        const serializer = new XMLSerializer();
        const html = serializer.serializeToString(resultDocument);
        previewFrame.srcdoc = html;

        setTimeout(() => {
          const iframeDoc = previewFrame.contentDocument;
          iframeDoc.addEventListener('click', function(e) {
            const outerHTML = e.target.outerHTML;
            const cleanHTML = outerHTML.replace(/[\n\r]/g, '').replace(/\s+/g, ' ');
            const cursorPos = xsltEditor.getValue().indexOf(cleanHTML.substring(0, 40));
            if (cursorPos >= 0) {
              xsltEditor.focus();
              xsltEditor.setCursor(xsltEditor.posFromIndex(cursorPos));
            }
          });
        }, 200);
      } catch (err) {
        previewFrame.srcdoc = `<pre style="color: red; padding: 1rem;">XSLT Error:\n${err}</pre>`;
      }

      renderImageThumbnails();
    }

    function renderImageThumbnails() {
      imageList.innerHTML = "";
      const xslt = xsltEditor.getValue();
      const imgRegex = /<img(?:\s+[^>]*?)?\s+src\s*=\s*["']([^"']+)["'][^>]*>/gim;

      let match;
      while ((match = imgRegex.exec(xslt)) !== null) {
        const src = match[1];
        const fullMatch = match[0];

        const container = document.createElement("div");
        container.className = "thumbnail";

        const img = document.createElement("img");
        img.src = src;

        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.onchange = (e => {
          const file = e.target.files[0];
          if (file.size > 65536) {
            alert("‚ö†Ô∏è Image exceeds 64KB limit.");
            return;
          }
          const reader = new FileReader();
          reader.onload = () => {
            const newDataUrl = reader.result;
            const currentXslt = xsltEditor.getValue();
            const updated = currentXslt.replace(fullMatch, fullMatch.replace(src, newDataUrl));
            xsltEditor.setValue(updated);
            updatePreview();
          };
          reader.readAsDataURL(file);
        });

        container.appendChild(img);
        container.appendChild(input);
        imageList.appendChild(container);
      }
    }

    newImageUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file || file.size > 65536) {
        alert("‚ö†Ô∏è Image exceeds 64KB or is invalid.");
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        const htmlCode = `<img src=\"${dataUrl}\" alt=\"signature\" />`;
        newImageOutput.textContent = htmlCode;
        renderImageThumbnails();
      };
      reader.readAsDataURL(file);
    });

    xsltEditor.on("change", updatePreview);

    xmlFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          const parser = new DOMParser();
          xmlDoc = parser.parseFromString(reader.result, 'text/xml');
          updatePreview();
        };
        reader.readAsText(file);
      }
    });

    xsltFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          xsltEditor.setValue(reader.result);
          updatePreview();
        };
        reader.readAsText(file);
      }
    });

    downloadBtn.addEventListener('click', () => {
      const blob = new Blob([xsltEditor.getValue()], { type: 'application/xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'modified_template.xslt';
      a.click();
      URL.revokeObjectURL(url);
    });
    function copyImageCode() {
      const code = document.getElementById("newImageOutput").innerText;
      navigator.clipboard.writeText(code).then(() => alert("Copied to clipboard!"));
    }
    function clearImageOutput() {
      document.getElementById("newImageOutput").textContent = "";
    }
  </script>
</body>
</html>
